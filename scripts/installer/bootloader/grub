create_isolinux_grub_cfg() {
  local LABEL="$1"

  # create grub.cfg only if it doesn't exist
  if [[ ! -f "/image/boot/grub/grub.cfg" ]]; then
    echo "Creating grub.cfg..."
    cat <<EOF > /image/boot/grub/grub.cfg
insmod all_video

set default=0
set timeout=10

menuentry "$LABEL" {
  linux /casper/vmlinuz boot=casper
  initrd /casper/initrd.img
}

# grub_platform
if [ "\$grub_platform" = "efi" ]; then
menuentry 'UEFI Firmware Settings' {
  fwsetup
}

menuentry "Test memory Memtest86+ (UEFI)" {
  linux /install/memtest86+.efi
}
else
menuentry "Test memory Memtest86+ (BIOS)" {
  linux16 /install/memtest86+.bin
}
fi
EOF
  else
    echo "grub.cfg already exists, skipping..."
  fi
}

install_grub_efi() {
  local OS="$1"
  local ARCH="$2"

  sed -i 's/^GRUB_TIMEOUT_STYLE=.*/GRUB_TIMEOUT_STYLE=menu/' /etc/default/grub
  sed -i 's/^GRUB_TIMEOUT=.*/GRUB_TIMEOUT=3/' /etc/default/grub
  if ! grep -q 'init_on_alloc=0' /etc/default/grub; then
    sed -i 's/^\(GRUB_CMDLINE_LINUX_DEFAULT="[^"]*\)"/\1 init_on_alloc=0"/' /etc/default/grub
  fi

  # install grub-efi
  update-grub
  grub-install \
    --target=${ARCH}-efi \
    --efi-directory=/boot/efi \
    --bootloader-id=${OS} \
    --recheck
}
